# 1. Base image: Python 3.10 (Debian-based)
FROM python:3.10-slim

# 2. Install system tools (curl is needed to download Node.js)
RUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*

# 3. Install Node.js (Version 20)
#    This allows you to run 'node ai.js' inside the container
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && \
    apt-get install -y nodejs

# 4. Set working directory
WORKDIR /code

# 5. Install Python Dependencies
COPY app/requirements.txt /code/app/requirements.txt
RUN pip install --no-cache-dir --upgrade -r /code/app/requirements.txt

# 6. Install Node.js Dependencies
#    We copy package.json from 'src' to install npm libraries
COPY src/package.json /code/src/package.json
WORKDIR /code/src
RUN npm install

# 7. Copy the entire backend code
WORKDIR /code
COPY . /code

# 8. Expose ports (8000 for FastAPI, 3000 usually for Node - adjust if ai.js uses a different port)
EXPOSE 8000 3000

# 9. DEFAULT COMMAND
#    Since you want to run the AI script, we can make that the default.
#    (Or you can override this command when you run the container)
WORKDIR /code/src
CMD ["node", "ai.js"]